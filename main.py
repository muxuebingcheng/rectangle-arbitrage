#!/usr/bin/python
# -*- coding:utf8 -*-
#standard packages
import logging
import redis
import os,time
from multiprocessing import Pool
import json
import time
#log config
from calc import calc_core
from tools import generate_currency_pair_info

logging.basicConfig(level=logging.DEBUG,\
		format='%(asctime)s %(filename)s[line:%(lineno)d] %(levelname)s %(message)s',\
		datefmt='%m-%d %H:%M',\
		filename='log/debug.log',\
		filemode='a')

#test data
source_str1="""{"code":"200","msg":"ok","data":[{"symbol":"hsr-eth","bids":[[0.01105,2.2376],[0.010981,16.95],[0.010979,34],[0.010978,82.2761],[0.010972,0.0007],[0.010936,182.473],[0.010922,86.7123]],"asks":[[0.011123,34],[0.011124,182.473],[0.01116,34],[0.011168,70.8],[0.011173,56.52],[0.011253,68],[0.011254,88.9182]]},{"symbol":"mtn-eth","bids":[[0.000275,72022.94],[0.00027401,250],[0.000274,98323.6],[0.00027301,250],[0.000273,97680.08],[0.00027201,250],[0.000272,98039.2]],"asks":[[0.00027608,1242.27],[0.00027699,315.48],[0.0002775,461.02],[0.00027965,1350],[0.00028,100.29187725631769],[0.00028104,4050],[0.00028105,4098.56]]},{"symbol":"pay-eth","bids":[[0.00185,2.21],[0.0018339,110],[0.0018338,1253.47],[0.0018336,132.4],[0.00182233,236.6],[0.00180374,254.54],[0.00178521,533.8]],"asks":[[0.00185001,0.1],[0.00185202,0.1],[0.00186086,0.02],[0.00188659,1049.07],[0.0018866,314.4],[0.00188678,236.6],[0.00189,300]]},{"symbol":"let-eth","bids":[[7.227e-5,6400],[7.212e-5,9400],[7.211e-5,9600],[7.21e-5,523.49],[7.2e-5,27777.78],[7.189e-5,48.68],[7.113e-5,15354.6]],"asks":[[7.284e-5,3.8],[7.318e-5,6400],[7.32e-5,15800],[7.321e-5,2058.96],[7.327e-5,2240],[7.339e-5,8153.97],[7.438e-5,4654.07]]},{"symbol":"ht-btc","bids":[[0.00019561,1064.59],[0.0001952,0.24],[0.0001949,1080],[0.00019484,1812],[0.00019477,300],[0.00019463,520.12],[0.00019461,1997.38]],"asks":[[0.00019606,1200],[0.00019612,1080],[0.00019624,2168],[0.00019626,500],[0.00019637,473.39],[0.0001964,1000],[0.00019655,1473]]},{"symbol":"mds-eth","bids":[[0.00024029,367],[0.00023859,2884],[0.00023789,93],[0.00023739,2840],[0.00023738,6648],[0.00023628,4464],[0.00023617,2989]],"asks":[[0.00024169,925],[0.00024254,339],[0.00024255,355],[0.00024454,4260],[0.00024455,455],[0.0002446,6883],[0.00024654,4260]]},{"symbol":"swftc-btc","bids":[[1.5e-6,81007.06],[1.49e-6,85615],[1.48e-6,154187.83],[1.47e-6,94871.47],[1.46e-6,129858.82],[1.45e-6,392001.44],[1.44e-6,2004.01]],"asks":[[1.51e-6,10555.14],[1.52e-6,1500],[1.53e-6,168599.69],[1.54e-6,202461.12],[1.55e-6,6000],[1.56e-6,187589.13],[1.57e-6,51500]]},{"symbol":"mtn-btc","bids":[[2.159e-5,924.04],[2.153e-5,1330],[2.15e-5,5000],[2.148e-5,187.24],[2.141e-5,8719],[2.14e-5,845],[2.123e-5,1330]],"asks":[[2.172e-5,1566.3],[2.192e-5,2660],[2.194e-5,1330],[2.195e-5,622.57],[2.203e-5,1330],[2.208e-5,3553.61],[2.209e-5,514.27]]},{"symbol":"eth-btc","bids":[[0.078782,16.05],[0.078779,5.38],[0.078776,0.525],[0.078774,5.776],[0.078766,0.234],[0.07873,5.47],[0.078729,0.8]],"asks":[[0.078892,0.2137],[0.078971,0.0301],[0.079035,0.6399],[0.079062,0.945],[0.079087,23.253],[0.079092,2.69],[0.079096,1.317]]},{"symbol":"hsr-btc","bids":[[0.000872,25.2303],[0.000871,384],[0.00087,241.1533],[0.000869,20.02],[0.000866,77.6095],[0.000861,326.9807],[0.000857,384.2387]],"asks":[[0.000876,88.1],[0.000877,2],[0.000879,25],[0.00088,10.78],[0.000881,2],[0.000886,2],[0.000887,1086.8]]},{"symbol":"trx-eth","bids":[[6.136e-5,0.28],[6.096e-5,25518.75],[6.095e-5,21231.74],[6.082e-5,19600],[6.081e-5,1979.22],[6.065e-5,25559.53],[6.051e-5,7840]],"asks":[[6.149e-5,19600],[6.15e-5,8962.87],[6.173e-5,17780],[6.174e-5,1976.68],[6.177e-5,19600],[6.178e-5,1332.17],[6.18e-5,18589.65]]},{"symbol":"zla-btc","bids":[[2.556e-5,60.43],[2.552e-5,350.77],[2.546e-5,2021.37],[2.541e-5,4247.39],[2.54e-5,999.25],[2.533e-5,2718],[2.53e-5,1000]],"asks":[[2.587e-5,198.25],[2.606e-5,9.61],[2.609e-5,3280],[2.61e-5,1674.29],[2.623e-5,2443.53],[2.635e-5,10000],[2.636e-5,2839.27]]},{"symbol":"ht-eth","bids":[[0.00248088,1224.44],[0.00248087,1.53],[0.00247224,900],[0.00247201,7024],[0.002472,541.8],[0.00247125,475.63],[0.00247,964.83]],"asks":[[0.00248698,26.33],[0.002487,9750.66],[0.00249066,300],[0.00249143,2160],[0.0024916,52.95],[0.00249161,0.04],[0.00249349,12320]]},{"symbol":"gnt-eth","bids":[[0.00049295,4073],[0.00049294,1972],[0.00049031,892],[0.000489,562],[0.0004854,472],[0.00048401,2488],[0.000484,14545]],"asks":[[0.00049778,1920.751255574752],[0.0004978,260],[0.0005056,367],[0.0005077,3140],[0.00050771,1986],[0.00050838,892],[0.0005088,16885]]},{"symbol":"gnt-btc","bids":[[3.908e-5,6209],[3.907e-5,2676],[3.906e-5,1035],[3.904e-5,1332],[3.888e-5,2618],[3.879e-5,828],[3.875e-5,2429]],"asks":[[3.988e-5,1332],[3.99e-5,304],[3.998e-5,1152],[4.0e-5,2000],[4.004e-5,1050],[4.007e-5,5165],[4.022e-5,1044]]},{"symbol":"nas-eth","bids":[[0.00938,0.01],[0.00935,0.01],[0.009311,100],[0.00931,101.435],[0.009308,13.1103],[0.009306,5.5538],[0.009305,7]],"asks":[[0.009399,58.5],[0.0094,290.521],[0.009411,42.479],[0.00943,25.8621],[0.009463,74],[0.009464,74],[0.00948,148]]},{"symbol":"trx-btc","bids":[[4.83e-6,17324.63],[4.82e-6,39200],[4.78e-6,13.69],[4.77e-6,61200],[4.76e-6,731910.76],[4.75e-6,39299.76],[4.74e-6,782.61]],"asks":[[4.85e-6,10000],[4.86e-6,17640],[4.87e-6,95018.65],[4.88e-6,20000],[4.89e-6,16388.22],[4.9e-6,22114.43],[4.91e-6,2000]]},{"symbol":"mds-btc","bids":[[1.891e-5,325298],[1.89e-5,30382],[1.883e-5,50000],[1.878e-5,237131],[1.876e-5,14721],[1.867e-5,10695],[1.859e-5,255]],"asks":[[1.9e-5,3],[1.901e-5,157],[1.902e-5,1104],[1.903e-5,1290],[1.917e-5,1110],[1.919e-5,140],[1.923e-5,9530]]},{"symbol":"let-btc","bids":[[5.72e-6,200],[5.67e-6,19754.01],[5.66e-6,828.91],[5.65e-6,29481],[5.64e-6,33098.2],[5.58e-6,300],[5.5e-6,1189.53]],"asks":[[5.76e-6,6400],[5.77e-6,13319.02],[5.79e-6,6400],[5.8e-6,2051.47],[5.81e-6,3333.33],[5.82e-6,3333.33],[5.91e-6,2993.99]]},{"symbol":"elf-eth","bids":[[0.00134847,91],[0.0013396,42],[0.00133883,968],[0.00133881,516],[0.00133872,753],[0.00133192,978],[0.00132884,69]],"asks":[[0.00135599,2060],[0.001356,566],[0.00135654,103],[0.00136262,645],[0.00136424,300],[0.00136612,248],[0.00136613,458]]},{"symbol":"iost-eth","bids":[[3.991e-5,19783.07],[3.981e-5,838.0000803818136],[3.977e-5,31600],[3.976e-5,15082.13],[3.973e-5,13690],[3.972e-5,35053.12],[3.966e-5,14132.2]],"asks":[[4.014e-5,1429],[4.018e-5,3746.98],[4.036e-5,1684.12],[4.041e-5,5149],[4.055e-5,76400],[4.062e-5,11600],[4.063e-5,33442.09]]}]}"""
source_str="""{"code":"200","msg":"ok","data":[{"symbol":"hsr-eth","bids":[[0.01105,2.2376],[0.010981,16.95],[0.010979,34],[0.010978,82.2761],[0.010972,0.0007],[0.010936,182.473],[0.010922,86.7123]],"asks":[[0.011123,34],[0.011124,182.473],[0.01116,34],[0.011168,70.8],[0.011173,56.52],[0.011253,68],[0.011254,88.9182]]}]}"""



if __name__ == "__main__":
    pool = redis.ConnectionPool(host='127.0.0.1', port=6379,
                                decode_responses=True)  # host是redis主机，需要redis服务端和客户端都起着 redis默认端口是6379
    r = redis.Redis(connection_pool=pool)
    # 启动多进程处理函数
    p = Pool(4)
    for x in ['mtn', 'hsr']:
        p.apply_async(calc_core.calc_fork,args=(x,))

    print('Waiting for all subprocesses done...')
    p.close()
    p.join()
    print('All subprocesses done.')

    while True:
        # ws.recv()接受信息处理
        time.sleep(1)
        currency_info_str = ""
        currency_info_str = r.lpop("source")
        if (currency_info_str == None):
            print("数据空")
            continue
        currency_info_dict = json.loads(currency_info_str)
        generate_currency_pair_info.gen_currency_pair_info(currency_info_dict, r)

